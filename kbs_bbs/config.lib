AC_ARG_WITH(zlib,
[  --with-zlib[=DIR]
       Include ZLIB support (requires zlib >= 1.0.9).],
ZLIB_DIR="$withval", ZLIB_DIR="yes")

if test "$ZLIB_DIR" != "no"; then
  if test -f $ZLIB_DIR/include/zlib.h; then
      ZLIB_INC=$ZLIB_DIR/include
  else
    for i in /usr/local /usr ; do
      if test -f $i/include/zlib/zlib.h; then
        ZLIB_DIR=$i
        ZLIB_INC=$i/include/zlib
      elif test -f $i/include/zlib.h; then
        ZLIB_DIR=$i
        ZLIB_INC=$i/include
      fi
    done
  fi
  
  if test -z "$ZLIB_DIR"; then
    AC_MSG_ERROR(Cannot find libz)
  fi

  AC_CHECK_LIB(z, gzgets, [
    AC_DEFINE(HAVE_ZLIB,1,[ ])
  ],[
    AC_MSG_ERROR(ZLIB extension requires zlib >= 1.0.9)
  ])
  
  ZLIB_LIBS="-L$ZLIB_DIR/lib -lz"
  ZLIB_INC="-I$ZLIB_INC"
else
  AC_MSG_ERROR(Need zlib support)
fi

LIBS="$LIBS $ZLIB_LIBS"
CFLAGS="$CFLAGS $ZLIB_INC"

AC_ARG_WITH(mysql,
[  --with-mysql[=DIR]
       Include MySQL support.],
MYSQL_DIR="$withval", MYSQL_DIR="yes")

if test "$MYSQL_DIR" != "no"; then
  if test -f $MYSQL_DIR/include/mysql/mysql.h; then
      MYSQL_INC=$MYSQL_DIR/include/mysql
  else
    for i in /usr/local /usr ; do
      if test -f $i/include/mysql/mysql.h; then
        MYSQL_DIR=$i
        MYSQL_INC=$i/include/mysql
      elif test -f $i/include/mysql.h; then
        MYSQL_DIR=$i
        MYSQL_INC=$i/include
      elif test -f $i/mysql/include/mysql.h; then
        MYSQL_DIR=$i/mysql
        MYSQL_INC=$i/mysql/include
      fi
    done
  fi
  
  if test -z "$MYSQL_DIR"; then
    AC_MSG_ERROR(Cannot find MySQL library.)
  fi

  SAVE_LIBS=$LIBS
  LIBS="$LIBS -L$MYSQL_DIR/lib"
  AC_CHECK_LIB(mysqlclient, mysql_real_connect, [
    AC_DEFINE(HAVE_MYSQL,1,[ ])
  ],[
	AC_MSG_ERROR(MYSQL extension required)
  ],[ -L$MYSQL_DIR/lib/mysql ])
  LIBS=$SAVE_LIBS

  MYSQL_LIBS="-L$MYSQL_DIR/lib -L$MYSQL_DIR/lib/mysql -lmysqlclient"
  MYSQL_INC="-I$MYSQL_INC"
else
  AC_MSG_ERROR(Need MySQL support)
fi

LIBS="$LIBS $MYSQL_LIBS"
CFLAGS="$CFLAGS $MYSQL_INC"

AC_CHECK_LIB([bsd], [vfork], [LIBS="$LIBS -lbsd"])
AC_CHECK_LIB([dl], [dlopen], [LIBS="$LIBS -ldl"])
AC_CHECK_LIB([esmtp], [smtp_create_session], [LIBS="$LIBS -lesmtp"])
AC_CHECK_LIB([ltdl], [lt_dlopen], [LIBS="$LIBS -lltdl"])

