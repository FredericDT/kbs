水木代码安装指南(1.0)
0. ChangeLog
  该文档由水木清华BBS站系统维护站务维护。
2002.7.31
  COMMAN 加入对 ssh 部分的说明, 修正 pop3s 的说明  
2002.7.27
  KCN v1.1
  加入pop3s，ssh部分的说明
2002.6.29
  flyriver v1.0

1. 需要的软件:
autoconf >2.54
automake >1.6
libtool-1.4
libesmtp-0.8.11 (最好编译成无pthread支持的)
(下面是WWW支持需要的)
apache_1.3.X
php > 4.2.0
openssl		(下面是POP3S需要的)

2. 安装水木的源码
  1)获得smthbbs-x.x.tar.gz的包。其中x.x版本号
  2)展开源码包
  	tar zxvf smthbbs-x.x.tar.gz
  3)进入源码目录
  	cd smthbbs-x.x
  4)配置
  ./configure --enable-site=devel --disable-www
     注意在 site/ 字目录里面必须有名字为 devel.c和 devel.h 的文件
     并注意验证相应的 .h 文件中 BBSUID 和 BBSGID 与安装用户的uid gid
     是否一致。 

     bbs缺省安装在/home/bbs，如果需要指定别的目录，使用--prefix指定。
     后面将使用$(BBSHOME)表示安装的BBS目录，在安装的时候请使用真正路径
替代。
  5)编译
  	make
  5)安装
	最后用 root 来 make install. 
  	make install
  	成功安装之后, 用 root 用户在 /usr/lib 做如下文件链接:
ln -s (BBSHOME)/lib/libBBS.so /usr/lib
ln -s (BBSHOME)/lib/libBBS.so.0 /usr/lib
ln -s (BBSHOME)/lib/libzmodem.so /usr/lib
ln -s (BBSHOME)/lib/libsystem.so /usr/lib
ln -s (BBSHOME)/lib/libsystem.so.0 /usr/lib
	或者在系统的动态库查询目录列表里面加入$(BBSHOME)/lib

3. WWW的支持
在完成以上步骤之后，按以下步骤安装WWW的支持。
假设 apache 安装在 /home/apache, 在该目录下有 cgi-bin/ 和 htdocs/ 目录.
在 cgi-bin/ 中建立一个 bbs 子目录, 后面的 bbs2www cgi 程序将放在这个目录.
htdocs/ 必须是 web 服务器的虚拟 /, 后面的 html, php 脚本等文件将放在这个
目录里面. 另外, 在 httpd.conf 中, 加上.php 作为 php 脚本的后缀.

假设 php 的源代码在 /home/flyriver/download/php-4.2.1 里面, 必须是
./configure 过的.

建议 apache 在 ./configure 时加上 --enable-module=so, php 在 ./configure
时则加上 --with-apxs=/home/apache/bin/apxs. apache 进程必须用 bbs 用户跑.

重新配置水木源码, ./configure --prefix=/home/system/bbs --enable-site=devel
--with-www=/home/apache --with-php=/home/flyriver/download/php-4.2.1
然后 make, 再用 root 用户 make install, 再在 /usr/lib 做如下文件链接:
ln -s (BBSHOME)/lib/libbbslib.so /usr/lib
ln -s (BBSHOME)/lib/libbbslib.so.0 /usr/lib
	或者在系统的动态库查询目录列表里面加入$(BBSHOME)/lib
	
然后 cd /usr/local/lib/php/extensions/no-debug-non-zts-20020429, 这个目录与
如何编译安装有关系, 实际上它就是 php 放置 extension 的目录. 做如下链接:
ln -s /home/apache/libexec/bbs/libphpbbslib.so libphpbbslib.so

复制 /home/apache/libexec/bbs/funcs.php 到 /home/apahce/htdocs 目录, 改名为
funcs.php, 编辑这个 funcs.jsp 文件, 把 dl("../libexec/bbs/libphpbbslib.so")
修改为 dl("libphpbbslib.so").

看看 $(BBSHOME)/ 及其子目录的权限是否正确, bin/ 和 lib/ 子目录及其文件
的属主如果是 root 也没有关系. 进入 bin/ 目录, 运行
                ./miscd daemon
                ./bbsd -p port
                ./newpop3d
                ./bbslogd
                ./webmsgd
然后就可以用 telnet 访问 BBS 系统了. 再启动 apache 就可以从 web 端访问 BBS
系统了.

4. SSH 的支持
  如果想加上 ssh 支持, 在 ./configure 时加上 --enable-ssh, 不过必须有 sshbbsd
的源代码存在. 其他的参数请参考 ./configure --help 的输出.
  ssh 的配置文件并未包含在发布包中，请自己从 ssh 1.2.x 的包里面找到范例编写
配置文件都放在 bbshome/etc 下面, 如果是初次架站没有密钥，需要使用 ssh 1.2.x
的 ssh-keygen 生成一个

5. 其他
  pop3s的支持：在./configure的时候加上--with-openssl[=path]，生成的newpop3d将
  自动包含pop3和pop3s的支持。
  pop3s 支持需要一个证书，可以用 openssl 生成并放置在 bbshome/etc/bbs.crt 和 bbs.key
  

